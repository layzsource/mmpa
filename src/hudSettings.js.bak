// Settings HUD Section (Phase 13.0)
// User-configurable save paths and filename patterns

import { getSettings, updateSettings, chooseDirectory } from './settings.js';
import { FlightParams } from './flightParams.js';
import {
  COLOR_PALETTES,
  applyColorPalette,
  getCurrentPalette,
  getArchetypeNames,
  updateCustomColor,
  getCustomPalette,
  resetCustomPalette,
  COLOR_GENERATION_RULES,
  applyGeneratedPalette,
  getPersonalizedRecommendations,
  suggestPalette,
  setTrackingEnabled,
  clearUsageData,
  downloadPalettesJSON,
  importPalettes,
  savePaletteVersion,
  restorePaletteVersion,
  getPaletteVersions,
  deletePaletteVersion,
  exportVersionHistory,
  importVersionHistory
} from './colorPalettes.js';

export function createSettingsHudSection(container) {
  const section = document.createElement('div');
  section.className = 'hud-section';

  // Title
  const title = document.createElement('h4');
  title.textContent = 'âš™ï¸ Save Paths Configuration';
  title.style.cssText = 'margin: 10px 0; color: #00ffff; font-size: 13px; font-weight: 500;';
  section.appendChild(title);

  // Description
  const desc = document.createElement('p');
  desc.textContent = 'Configure where timeline and training data files are saved';
  desc.style.cssText = 'margin: 0 0 15px 0; color: #888; font-size: 11px;';
  section.appendChild(desc);

  // Path configurations
  const pathConfigs = [
    { key: 'timelines', label: 'Timeline JSONs', description: 'Preset and chain timeline files' },
    { key: 'trainingData', label: 'Training Data', description: 'CSV files for analysis' },
    { key: 'experiments', label: 'Experiments', description: 'Domain-specific test data' }
  ];

  pathConfigs.forEach(({ key, label, description }) => {
    const pathGroup = document.createElement('div');
    pathGroup.style.cssText = 'margin-bottom: 15px; padding: 10px; background: rgba(0, 255, 255, 0.05); border-radius: 4px;';

    const pathLabel = document.createElement('div');
    pathLabel.textContent = label;
    pathLabel.style.cssText = 'color: #00ffff; font-size: 11px; margin-bottom: 4px; font-weight: 500;';
    pathGroup.appendChild(pathLabel);

    const pathDesc = document.createElement('div');
    pathDesc.textContent = description;
    pathDesc.style.cssText = 'color: #666; font-size: 10px; margin-bottom: 6px;';
    pathGroup.appendChild(pathDesc);

    const pathRow = document.createElement('div');
    pathRow.style.cssText = 'display: flex; gap: 8px; align-items: center;';

    const pathInput = document.createElement('input');
    pathInput.type = 'text';
    pathInput.value = getSettings().savePaths[key] || '';
    pathInput.style.cssText = 'flex: 1; padding: 4px 8px; background: #1a1a1a; color: #00ffff; border: 1px solid #333; border-radius: 3px; font-size: 11px; font-family: monospace;';
    pathInput.readOnly = true;
    pathRow.appendChild(pathInput);

    const browseBtn = document.createElement('button');
    browseBtn.textContent = 'Browse';
    browseBtn.style.cssText = 'padding: 4px 12px; background: #2a2a2a; color: #00ffff; border: 1px solid #444; border-radius: 3px; cursor: pointer; font-size: 11px; transition: all 0.2s;';
    browseBtn.addEventListener('mouseover', () => {
      browseBtn.style.background = '#3a3a3a';
      browseBtn.style.borderColor = '#00ffff';
    });
    browseBtn.addEventListener('mouseout', () => {
      browseBtn.style.background = '#2a2a2a';
      browseBtn.style.borderColor = '#444';
    });
    browseBtn.addEventListener('click', async () => {
      const newPath = await chooseDirectory(pathInput.value);
      if (newPath) {
        pathInput.value = newPath;
        const settings = getSettings();
        settings.savePaths[key] = newPath;
        await updateSettings(settings);
        console.log(`âœ… Updated ${label} path to: ${newPath}`);
      }
    });
    pathRow.appendChild(browseBtn);

    pathGroup.appendChild(pathRow);
    section.appendChild(pathGroup);
  });

  // Filename patterns
  const patternTitle = document.createElement('h4');
  patternTitle.textContent = 'ðŸ“ Filename Patterns';
  patternTitle.style.cssText = 'margin: 20px 0 10px 0; color: #00ffff; font-size: 13px; font-weight: 500;';
  section.appendChild(patternTitle);

  const patternDesc = document.createElement('p');
  patternDesc.textContent = 'Customize filenames. Use {date} for YYYY-MM-DD, {timestamp} for Unix timestamp';
  patternDesc.style.cssText = 'margin: 0 0 15px 0; color: #888; font-size: 11px;';
  section.appendChild(patternDesc);

  const patternConfigs = [
    { key: 'presets', label: 'Presets', default: 'presets_{date}' },
    { key: 'chains', label: 'Chains', default: 'chains_{date}' },
    { key: 'training', label: 'Training', default: 'training_{date}' }
  ];

  patternConfigs.forEach(({ key, label, default: defaultPattern }) => {
    const patternGroup = document.createElement('div');
    patternGroup.style.cssText = 'margin-bottom: 10px;';

    const patternLabel = document.createElement('label');
    patternLabel.textContent = label;
    patternLabel.style.cssText = 'display: block; color: #00ffff; font-size: 11px; margin-bottom: 4px;';
    patternGroup.appendChild(patternLabel);

    const patternInput = document.createElement('input');
    patternInput.type = 'text';
    patternInput.value = getSettings().filenamePatterns[key] || defaultPattern;
    patternInput.placeholder = defaultPattern;
    patternInput.style.cssText = 'width: 100%; padding: 4px 8px; background: #1a1a1a; color: #00ffff; border: 1px solid #333; border-radius: 3px; font-size: 11px; font-family: monospace;';

    patternInput.addEventListener('change', async () => {
      const settings = getSettings();
      settings.filenamePatterns[key] = patternInput.value || defaultPattern;
      await updateSettings(settings);
      console.log(`âœ… Updated ${label} pattern to: ${patternInput.value}`);
    });

    patternGroup.appendChild(patternInput);
    section.appendChild(patternGroup);
  });

  // Controller Sensitivity Section
  const controllerTitle = document.createElement('h4');
  controllerTitle.textContent = 'ðŸŽ® Controller Sensitivity';
  controllerTitle.style.cssText = 'margin: 20px 0 10px 0; color: #00ffff; font-size: 13px; font-weight: 500;';
  section.appendChild(controllerTitle);

  const controllerDesc = document.createElement('p');
  controllerDesc.textContent = 'Adjust gamepad look sensitivity for more precise or faster camera control';
  controllerDesc.style.cssText = 'margin: 0 0 15px 0; color: #888; font-size: 11px;';
  section.appendChild(controllerDesc);

  const controllerSettings = getSettings().controller || { yawSensitivity: 3.0, pitchSensitivity: 2.5 };

  // Yaw Sensitivity Slider
  const yawGroup = document.createElement('div');
  yawGroup.style.cssText = 'margin-bottom: 15px;';

  const yawLabel = document.createElement('label');
  yawLabel.style.cssText = 'display: flex; justify-content: space-between; align-items: center; color: #00ffff; font-size: 11px; margin-bottom: 6px;';

  const yawLabelText = document.createElement('span');
  yawLabelText.textContent = 'Yaw Sensitivity (Left/Right)';
  yawLabel.appendChild(yawLabelText);

  const yawValueDisplay = document.createElement('span');
  yawValueDisplay.textContent = controllerSettings.yawSensitivity.toFixed(1);
  yawValueDisplay.style.cssText = 'color: #6644aa; font-family: monospace; font-weight: 500;';
  yawLabel.appendChild(yawValueDisplay);

  yawGroup.appendChild(yawLabel);

  const yawSlider = document.createElement('input');
  yawSlider.type = 'range';
  yawSlider.min = '0.5';
  yawSlider.max = '10.0';
  yawSlider.step = '0.1';
  yawSlider.value = controllerSettings.yawSensitivity;
  yawSlider.style.cssText = 'width: 100%; cursor: pointer;';

  yawSlider.addEventListener('input', async (e) => {
    const value = parseFloat(e.target.value);
    yawValueDisplay.textContent = value.toFixed(1);

    // Update FlightParams directly for immediate effect
    FlightParams.look.yawSensitivity = value;

    // Save to settings for persistence
    const settings = getSettings();
    if (!settings.controller) settings.controller = {};
    settings.controller.yawSensitivity = value;
    await updateSettings(settings);

    console.log(`ðŸŽ® Yaw sensitivity updated to: ${value}`);
  });

  yawGroup.appendChild(yawSlider);

  // Min/Max labels
  const yawRange = document.createElement('div');
  yawRange.style.cssText = 'display: flex; justify-content: space-between; color: #666; font-size: 9px; margin-top: 2px;';
  yawRange.innerHTML = '<span>0.5 (Slower)</span><span>10.0 (Faster)</span>';
  yawGroup.appendChild(yawRange);

  section.appendChild(yawGroup);

  // Pitch Sensitivity Slider
  const pitchGroup = document.createElement('div');
  pitchGroup.style.cssText = 'margin-bottom: 15px;';

  const pitchLabel = document.createElement('label');
  pitchLabel.style.cssText = 'display: flex; justify-content: space-between; align-items: center; color: #00ffff; font-size: 11px; margin-bottom: 6px;';

  const pitchLabelText = document.createElement('span');
  pitchLabelText.textContent = 'Pitch Sensitivity (Up/Down)';
  pitchLabel.appendChild(pitchLabelText);

  const pitchValueDisplay = document.createElement('span');
  pitchValueDisplay.textContent = controllerSettings.pitchSensitivity.toFixed(1);
  pitchValueDisplay.style.cssText = 'color: #6644aa; font-family: monospace; font-weight: 500;';
  pitchLabel.appendChild(pitchValueDisplay);

  pitchGroup.appendChild(pitchLabel);

  const pitchSlider = document.createElement('input');
  pitchSlider.type = 'range';
  pitchSlider.min = '0.5';
  pitchSlider.max = '10.0';
  pitchSlider.step = '0.1';
  pitchSlider.value = controllerSettings.pitchSensitivity;
  pitchSlider.style.cssText = 'width: 100%; cursor: pointer;';

  pitchSlider.addEventListener('input', async (e) => {
    const value = parseFloat(e.target.value);
    pitchValueDisplay.textContent = value.toFixed(1);

    // Update FlightParams directly for immediate effect
    FlightParams.look.pitchSensitivity = value;

    // Save to settings for persistence
    const settings = getSettings();
    if (!settings.controller) settings.controller = {};
    settings.controller.pitchSensitivity = value;
    await updateSettings(settings);

    console.log(`ðŸŽ® Pitch sensitivity updated to: ${value}`);
  });

  pitchGroup.appendChild(pitchSlider);

  // Min/Max labels
  const pitchRange = document.createElement('div');
  pitchRange.style.cssText = 'display: flex; justify-content: space-between; color: #666; font-size: 9px; margin-top: 2px;';
  pitchRange.innerHTML = '<span>0.5 (Slower)</span><span>10.0 (Faster)</span>';
  pitchGroup.appendChild(pitchRange);

  section.appendChild(pitchGroup);

  // Reset button
  const resetBtn = document.createElement('button');
  resetBtn.textContent = 'â†» Reset to Defaults';
  resetBtn.style.cssText = 'width: 100%; padding: 6px; background: rgba(102, 68, 170, 0.2); color: #6644aa; border: 1px solid #6644aa; border-radius: 3px; cursor: pointer; font-size: 10px; transition: all 0.2s;';

  resetBtn.addEventListener('mouseover', () => {
    resetBtn.style.background = 'rgba(102, 68, 170, 0.3)';
  });

  resetBtn.addEventListener('mouseout', () => {
    resetBtn.style.background = 'rgba(102, 68, 170, 0.2)';
  });

  resetBtn.addEventListener('click', async () => {
    const defaultYaw = 3.0;
    const defaultPitch = 2.5;

    yawSlider.value = defaultYaw;
    yawValueDisplay.textContent = defaultYaw.toFixed(1);
    pitchSlider.value = defaultPitch;
    pitchValueDisplay.textContent = defaultPitch.toFixed(1);

    FlightParams.look.yawSensitivity = defaultYaw;
    FlightParams.look.pitchSensitivity = defaultPitch;

    const settings = getSettings();
    if (!settings.controller) settings.controller = {};
    settings.controller.yawSensitivity = defaultYaw;
    settings.controller.pitchSensitivity = defaultPitch;
    await updateSettings(settings);

    console.log('ðŸŽ® Controller sensitivity reset to defaults');
  });

  section.appendChild(resetBtn);

  // Color Palette Section
  const colorPaletteTitle = document.createElement('h4');
  colorPaletteTitle.textContent = 'ðŸŽ¨ Synesthetic Color Mapping';
  colorPaletteTitle.style.cssText = 'margin: 20px 0 10px 0; color: #00ffff; font-size: 13px; font-weight: 500;';
  section.appendChild(colorPaletteTitle);

  const colorPaletteDesc = document.createElement('p');
  colorPaletteDesc.textContent = 'Choose how archetypes map to colors. Each palette has different empirical or artistic basis.';
  colorPaletteDesc.style.cssText = 'margin: 0 0 15px 0; color: #888; font-size: 11px;';
  section.appendChild(colorPaletteDesc);

  const paletteSelector = document.createElement('select');
  paletteSelector.style.cssText = 'width: 100%; padding: 6px; background: #1a1a1a; color: #00ffff; border: 1px solid #6644aa; border-radius: 3px; font-size: 11px; margin-bottom: 10px; cursor: pointer;';

  // Group palettes by category
  const palettesByCategory = {};
  Object.keys(COLOR_PALETTES).forEach(paletteName => {
    const palette = COLOR_PALETTES[paletteName];
    const category = palette.category || 'Other';
    if (!palettesByCategory[category]) {
      palettesByCategory[category] = [];
    }
    palettesByCategory[category].push(paletteName);
  });

  // Add palettes grouped by category
  Object.keys(palettesByCategory).sort().forEach(category => {
    const optgroup = document.createElement('optgroup');
    optgroup.label = category;
    optgroup.style.cssText = 'color: #6644aa; font-weight: bold;';

    palettesByCategory[category].forEach(paletteName => {
      const option = document.createElement('option');
      option.value = paletteName;
      option.textContent = paletteName;
      option.style.cssText = 'color: #00ffff;';
      optgroup.appendChild(option);
    });

    paletteSelector.appendChild(optgroup);
  });

  // Add Custom option in its own group
  const customGroup = document.createElement('optgroup');
  customGroup.label = 'Custom';
  customGroup.style.cssText = 'color: #6644aa; font-weight: bold;';
  const customOption = document.createElement('option');
  customOption.value = 'Custom';
  customOption.textContent = 'Custom (User-Defined)';
  customOption.style.cssText = 'color: #00ffff;';
  customGroup.appendChild(customOption);
  paletteSelector.appendChild(customGroup);

  paletteSelector.value = getCurrentPalette();

  // Description of selected palette
  const paletteDescDisplay = document.createElement('div');
  paletteDescDisplay.style.cssText = 'padding: 10px; background: rgba(0, 255, 255, 0.05); border: 1px solid #333; border-radius: 4px; font-size: 10px; color: #888; font-style: italic; margin-bottom: 10px;';

  function updateDescription() {
    if (paletteSelector.value === 'Custom') {
      const customPal = getCustomPalette();
      paletteDescDisplay.textContent = customPal?.description || 'Your personalized color mapping';
    } else {
      paletteDescDisplay.textContent = COLOR_PALETTES[paletteSelector.value].description;
    }
  }

  updateDescription();

  // Custom color editor (hidden by default)
  const customEditorContainer = document.createElement('div');
  customEditorContainer.style.cssText = 'display: none; margin-top: 15px; padding: 15px; background: rgba(0, 0, 0, 0.3); border: 1px solid #6644aa; border-radius: 4px;';

  paletteSelector.addEventListener('change', (e) => {
    applyColorPalette(e.target.value);
    updateDescription();

    // Show/hide custom editor
    if (e.target.value === 'Custom') {
      customEditorContainer.style.display = 'block';
      createCustomColorEditor(customEditorContainer);
    } else {
      customEditorContainer.style.display = 'none';
    }

    console.log(`ðŸŽ¨ Color palette changed to: ${e.target.value}`);
  });

  section.appendChild(paletteSelector);
  section.appendChild(paletteDescDisplay);
  section.appendChild(customEditorContainer);

  // Initialize custom editor if currently selected
  if (getCurrentPalette() === 'Custom') {
    customEditorContainer.style.display = 'block';
    createCustomColorEditor(customEditorContainer);
  }

  // Status indicator
  const status = document.createElement('div');
  status.style.cssText = 'margin-top: 20px; padding: 10px; background: rgba(0, 255, 0, 0.1); border-left: 3px solid #0f0; border-radius: 3px;';

  const statusTitle = document.createElement('div');
  statusTitle.textContent = 'âœ… Settings Auto-Saved';
  statusTitle.style.cssText = 'color: #0f0; font-size: 11px; font-weight: 500; margin-bottom: 4px;';
  status.appendChild(statusTitle);

  const statusDesc = document.createElement('div');
  statusDesc.textContent = 'Changes are saved automatically. Files will be saved to these locations when exported.';
  statusDesc.style.cssText = 'color: #888; font-size: 10px;';
  status.appendChild(statusDesc);

  section.appendChild(status);

  container.appendChild(section);
}

// Helper function to create custom color editor
function createCustomColorEditor(container) {
  container.innerHTML = ''; // Clear existing content

  const customPal = getCustomPalette();
  if (!customPal) return;

  // Header with reset button
  const header = document.createElement('div');
  header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #333;';

  const headerTitle = document.createElement('h5');
  headerTitle.textContent = 'Custom Palette Editor';
  headerTitle.style.cssText = 'color: #00ffff; font-size: 12px; margin: 0;';
  header.appendChild(headerTitle);

  const resetSection = document.createElement('div');
  resetSection.style.cssText = 'display: flex; gap: 8px; align-items: center;';

  const resetLabel = document.createElement('span');
  resetLabel.textContent = 'Reset from:';
  resetLabel.style.cssText = 'color: #888; font-size: 10px;';
  resetSection.appendChild(resetLabel);

  const resetSelector = document.createElement('select');
  resetSelector.style.cssText = 'padding: 3px 6px; background: #1a1a1a; color: #00ffff; border: 1px solid #444; border-radius: 3px; font-size: 10px; cursor: pointer;';

  Object.keys(COLOR_PALETTES).forEach(paletteName => {
    const option = document.createElement('option');
    option.value = paletteName;
    option.textContent = paletteName;
    resetSelector.appendChild(option);
  });

  resetSelector.addEventListener('change', (e) => {
    if (confirm(`Reset custom palette to "${e.target.value}"?`)) {
      resetCustomPalette(e.target.value);
      createCustomColorEditor(container); // Rebuild UI
      console.log(`âœ… Custom palette reset to ${e.target.value}`);
    }
  });

  resetSection.appendChild(resetSelector);
  header.appendChild(resetSection);
  container.appendChild(header);

  // ===== PHASE 3: RULE-BASED GENERATION =====
  const generatorSection = document.createElement('div');
  generatorSection.style.cssText = 'margin-bottom: 20px; padding: 15px; background: rgba(102, 68, 170, 0.1); border: 1px solid #6644aa; border-radius: 4px;';

  const generatorTitle = document.createElement('h5');
  generatorTitle.textContent = 'ðŸŽ² Generate from Rule';
  generatorTitle.style.cssText = 'color: #00ffff; font-size: 12px; margin: 0 0 10px 0;';
  generatorSection.appendChild(generatorTitle);

  const generatorDesc = document.createElement('div');
  generatorDesc.textContent = 'Algorithmically generate color palettes based on musical/mathematical properties';
  generatorDesc.style.cssText = 'color: #888; font-size: 10px; margin-bottom: 12px;';
  generatorSection.appendChild(generatorDesc);

  // Rule selector
  const ruleSelector = document.createElement('select');
  ruleSelector.style.cssText = 'width: 100%; padding: 6px; background: #1a1a1a; color: #00ffff; border: 1px solid #6644aa; border-radius: 3px; font-size: 10px; margin-bottom: 8px; cursor: pointer;';

  Object.keys(COLOR_GENERATION_RULES).forEach(ruleName => {
    const option = document.createElement('option');
    option.value = ruleName;
    option.textContent = ruleName;
    ruleSelector.appendChild(option);
  });

  // Rule description display
  const ruleDescDisplay = document.createElement('div');
  ruleDescDisplay.style.cssText = 'padding: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid #333; border-radius: 3px; font-size: 9px; color: #888; font-style: italic; margin-bottom: 12px; min-height: 32px;';
  ruleDescDisplay.textContent = COLOR_GENERATION_RULES[ruleSelector.value].description;

  ruleSelector.addEventListener('change', (e) => {
    ruleDescDisplay.textContent = COLOR_GENERATION_RULES[e.target.value].description;
    // Update color pickers with rule defaults
    const rule = COLOR_GENERATION_RULES[e.target.value];
    startColorPicker.value = rule.colorStart;
    endColorPicker.value = rule.colorEnd;
  });

  generatorSection.appendChild(ruleSelector);
  generatorSection.appendChild(ruleDescDisplay);

  // Color range controls
  const colorRangeRow = document.createElement('div');
  colorRangeRow.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;';

  const startColorGroup = document.createElement('div');
  const startColorLabel = document.createElement('label');
  startColorLabel.textContent = 'Start Color:';
  startColorLabel.style.cssText = 'display: block; color: #888; font-size: 9px; margin-bottom: 4px;';
  startColorGroup.appendChild(startColorLabel);

  const startColorPicker = document.createElement('input');
  startColorPicker.type = 'color';
  startColorPicker.value = COLOR_GENERATION_RULES[ruleSelector.value].colorStart;
  startColorPicker.style.cssText = 'width: 100%; height: 32px; background: #1a1a1a; border: 1px solid #6644aa; border-radius: 3px; cursor: pointer;';
  startColorGroup.appendChild(startColorPicker);

  const endColorGroup = document.createElement('div');
  const endColorLabel = document.createElement('label');
  endColorLabel.textContent = 'End Color:';
  endColorLabel.style.cssText = 'display: block; color: #888; font-size: 9px; margin-bottom: 4px;';
  endColorGroup.appendChild(endColorLabel);

  const endColorPicker = document.createElement('input');
  endColorPicker.type = 'color';
  endColorPicker.value = COLOR_GENERATION_RULES[ruleSelector.value].colorEnd;
  endColorPicker.style.cssText = 'width: 100%; height: 32px; background: #1a1a1a; border: 1px solid #6644aa; border-radius: 3px; cursor: pointer;';
  endColorGroup.appendChild(endColorPicker);

  colorRangeRow.appendChild(startColorGroup);
  colorRangeRow.appendChild(endColorGroup);
  generatorSection.appendChild(colorRangeRow);

  // Generate button
  const generateBtn = document.createElement('button');
  generateBtn.textContent = 'âœ¨ Generate & Apply Palette';
  generateBtn.style.cssText = 'width: 100%; padding: 8px 12px; background: linear-gradient(135deg, #6644aa 0%, #00ffff 100%); color: #000; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 500; transition: all 0.2s;';

  generateBtn.addEventListener('mouseover', () => {
    generateBtn.style.transform = 'scale(1.02)';
    generateBtn.style.boxShadow = '0 0 15px rgba(102, 68, 170, 0.5)';
  });

  generateBtn.addEventListener('mouseout', () => {
    generateBtn.style.transform = 'scale(1)';
    generateBtn.style.boxShadow = 'none';
  });

  generateBtn.addEventListener('click', () => {
    const ruleName = ruleSelector.value;
    const startColor = startColorPicker.value;
    const endColor = endColorPicker.value;

    applyGeneratedPalette(ruleName, startColor, endColor);
    createCustomColorEditor(container); // Rebuild UI to show new colors

    // Visual feedback
    generateBtn.textContent = 'âœ… Palette Generated!';
    setTimeout(() => {
      generateBtn.textContent = 'âœ¨ Generate & Apply Palette';
    }, 2000);
  });

  generatorSection.appendChild(generateBtn);
  container.appendChild(generatorSection);

  // ===== PHASE 4: ML-ASSISTED RECOMMENDATIONS =====
  const recommendationsSection = document.createElement('div');
  recommendationsSection.style.cssText = 'margin-top: 20px; padding: 15px; background: rgba(0, 255, 255, 0.05); border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 4px;';

  const recsTitle = document.createElement('h5');
  recsTitle.textContent = 'ðŸ¤– Suggested for You';
  recsTitle.style.cssText = 'color: #00ffff; font-size: 12px; margin: 0 0 10px 0;';
  recommendationsSection.appendChild(recsTitle);

  const recsDesc = document.createElement('div');
  recsDesc.textContent = 'AI-powered palette suggestions based on your usage patterns';
  recsDesc.style.cssText = 'color: #888; font-size: 10px; margin-bottom: 15px;';
  recommendationsSection.appendChild(recsDesc);

  // Get recommendations
  const recommendations = getPersonalizedRecommendations();

  // Most used palettes
  if (recommendations.mostUsed && recommendations.mostUsed.length > 0) {
    const mostUsedTitle = document.createElement('div');
    mostUsedTitle.textContent = 'Your Most Used Palettes:';
    mostUsedTitle.style.cssText = 'color: #888; font-size: 10px; margin-bottom: 8px;';
    recommendationsSection.appendChild(mostUsedTitle);

    const mostUsedList = document.createElement('div');
    mostUsedList.style.cssText = 'margin-bottom: 15px;';

    recommendations.mostUsed.forEach((palette, index) => {
      const paletteItem = document.createElement('div');
      paletteItem.style.cssText = 'display: flex; justify-content: space-between; padding: 6px 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid #333; border-radius: 3px; margin-bottom: 4px; font-size: 9px;';

      const paletteName = document.createElement('span');
      paletteName.textContent = `${index + 1}. ${palette.paletteName}`;
      paletteName.style.cssText = 'color: #00ffff;';

      const paletteStats = document.createElement('span');
      const durationMins = Math.round(palette.totalDuration / 60000);
      paletteStats.textContent = `${palette.usageCount} sessions, ${durationMins}m`;
      paletteStats.style.cssText = 'color: #666;';

      paletteItem.appendChild(paletteName);
      paletteItem.appendChild(paletteStats);
      mostUsedList.appendChild(paletteItem);
    });

    recommendationsSection.appendChild(mostUsedList);
  }

  // AI Suggestion
  if (recommendations.suggestion) {
    const suggestionTitle = document.createElement('div');
    suggestionTitle.textContent = 'AI-Generated Suggestion:';
    suggestionTitle.style.cssText = 'color: #888; font-size: 10px; margin-bottom: 8px;';
    recommendationsSection.appendChild(suggestionTitle);

    const suggestionBox = document.createElement('div');
    suggestionBox.style.cssText = 'padding: 10px; background: rgba(102, 68, 170, 0.2); border: 1px solid #6644aa; border-radius: 3px; margin-bottom: 12px;';

    if (recommendations.suggestion.type === 'preset') {
      const presetRec = document.createElement('div');
      presetRec.style.cssText = 'font-size: 10px; color: #888;';
      presetRec.innerHTML = `
        <div style="color: #00ffff; margin-bottom: 4px;">${recommendations.suggestion.paletteName}</div>
        <div style="font-style: italic;">${recommendations.suggestion.reason}</div>
      `;
      suggestionBox.appendChild(presetRec);
    } else if (recommendations.suggestion.type === 'generated') {
      const generatedRec = document.createElement('div');
      generatedRec.style.cssText = 'font-size: 10px; color: #888;';
      generatedRec.innerHTML = `
        <div style="color: #00ffff; margin-bottom: 4px;">Rule: ${recommendations.suggestion.rule}</div>
        <div style="margin-bottom: 8px; font-style: italic;">${recommendations.suggestion.reason}</div>
        <div style="display: flex; gap: 8px; align-items: center;">
          <span>Start:</span>
          <div style="width: 20px; height: 20px; background: ${recommendations.suggestion.startColor}; border: 1px solid #666; border-radius: 2px;"></div>
          <span>â†’</span>
          <div style="width: 20px; height: 20px; background: ${recommendations.suggestion.endColor}; border: 1px solid #666; border-radius: 2px;"></div>
          <span>End</span>
        </div>
      `;
      suggestionBox.appendChild(generatedRec);

      const applySuggestionBtn = document.createElement('button');
      applySuggestionBtn.textContent = 'âœ¨ Apply This Suggestion';
      applySuggestionBtn.style.cssText = 'width: 100%; padding: 8px; margin-top: 10px; background: linear-gradient(135deg, #6644aa, #8855cc); color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; transition: all 0.2s;';

      applySuggestionBtn.addEventListener('mouseover', () => {
        applySuggestionBtn.style.transform = 'scale(1.02)';
        applySuggestionBtn.style.boxShadow = '0 0 15px rgba(102, 68, 170, 0.5)';
      });

      applySuggestionBtn.addEventListener('mouseout', () => {
        applySuggestionBtn.style.transform = 'scale(1)';
        applySuggestionBtn.style.boxShadow = 'none';
      });

      applySuggestionBtn.addEventListener('click', () => {
        applyGeneratedPalette(
          recommendations.suggestion.rule,
          recommendations.suggestion.startColor,
          recommendations.suggestion.endColor
        );
        createCustomColorEditor(container); // Rebuild UI
        applySuggestionBtn.textContent = 'âœ… Suggestion Applied!';
        setTimeout(() => {
          applySuggestionBtn.textContent = 'âœ¨ Apply This Suggestion';
        }, 2000);
      });

      suggestionBox.appendChild(applySuggestionBtn);
    }

    recommendationsSection.appendChild(suggestionBox);
  }

  // Privacy controls
  const privacySection = document.createElement('div');
  privacySection.style.cssText = 'margin-top: 12px; padding-top: 12px; border-top: 1px dashed #333;';

  const privacyTitle = document.createElement('div');
  privacyTitle.textContent = 'ðŸ”’ Privacy Controls:';
  privacyTitle.style.cssText = 'color: #666; font-size: 9px; margin-bottom: 8px;';
  privacySection.appendChild(privacyTitle);

  const privacyButtons = document.createElement('div');
  privacyButtons.style.cssText = 'display: flex; gap: 8px;';

  const clearDataBtn = document.createElement('button');
  clearDataBtn.textContent = 'ðŸ—‘ï¸ Clear Usage Data';
  clearDataBtn.style.cssText = 'flex: 1; padding: 6px; background: rgba(220, 20, 60, 0.2); color: #dc143c; border: 1px solid #dc143c; border-radius: 3px; font-size: 9px; cursor: pointer; transition: all 0.2s;';

  clearDataBtn.addEventListener('mouseover', () => {
    clearDataBtn.style.background = 'rgba(220, 20, 60, 0.3)';
  });

  clearDataBtn.addEventListener('mouseout', () => {
    clearDataBtn.style.background = 'rgba(220, 20, 60, 0.2)';
  });

  clearDataBtn.addEventListener('click', () => {
    if (confirm('Clear all usage tracking data? This cannot be undone.')) {
      clearUsageData();
      createCustomColorEditor(container); // Rebuild UI
      clearDataBtn.textContent = 'âœ… Data Cleared';
      setTimeout(() => {
        clearDataBtn.textContent = 'ðŸ—‘ï¸ Clear Usage Data';
      }, 2000);
    }
  });

  privacyButtons.appendChild(clearDataBtn);
  privacySection.appendChild(privacyButtons);

  const privacyNote = document.createElement('div');
  privacyNote.textContent = 'All tracking data stays local on your device. No external data collection.';
  privacyNote.style.cssText = 'color: #444; font-size: 8px; margin-top: 8px; font-style: italic;';
  privacySection.appendChild(privacyNote);

  recommendationsSection.appendChild(privacySection);
  container.appendChild(recommendationsSection);

  // Divider
  const divider = document.createElement('div');
  divider.style.cssText = 'border-top: 1px solid #333; margin: 20px 0;';
  container.appendChild(divider);

  // Manual editing title
  const manualTitle = document.createElement('h5');
  manualTitle.textContent = 'ðŸŽ¨ Manual Color Editing';
  manualTitle.style.cssText = 'color: #888; font-size: 11px; margin: 0 0 15px 0;';
  container.appendChild(manualTitle);

  // Ï€ and Ï† colors
  const piPhiSection = document.createElement('div');
  piPhiSection.style.cssText = 'margin-bottom: 15px;';

  const piPhiTitle = document.createElement('div');
  piPhiTitle.textContent = 'Ï€/Ï† Synchronicity Colors:';
  piPhiTitle.style.cssText = 'color: #888; font-size: 10px; margin-bottom: 8px;';
  piPhiSection.appendChild(piPhiTitle);

  const piPhiGrid = document.createElement('div');
  piPhiGrid.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr; gap: 10px;';

  createColorInput(piPhiGrid, 'Ï€ (Chaos)', customPal.pi, (color) => {
    updateCustomColor('pi', color);
  });

  createColorInput(piPhiGrid, 'Ï† (Harmony)', customPal.phi, (color) => {
    updateCustomColor('phi', color);
  });

  piPhiSection.appendChild(piPhiGrid);
  container.appendChild(piPhiSection);

  // Archetype colors
  const archetypeSection = document.createElement('div');

  const archetypeTitle = document.createElement('div');
  archetypeTitle.textContent = 'Archetype Colors:';
  archetypeTitle.style.cssText = 'color: #888; font-size: 10px; margin-bottom: 8px;';
  archetypeSection.appendChild(archetypeTitle);

  const archetypeGrid = document.createElement('div');
  archetypeGrid.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr; gap: 10px;';

  const archetypeNames = getArchetypeNames();
  const archetypeLabels = {
    'PERFECT_FIFTH': 'Perfect Fifth',
    'WOLF_FIFTH': 'Wolf Fifth',
    'MAJOR_THIRD': 'Major Third',
    'MINOR_THIRD': 'Minor Third',
    'TRITONE': 'Tritone',
    'OCTAVE': 'Octave',
    'PERFECT_FOURTH': 'Perfect Fourth',
    'MAJOR_SIXTH': 'Major Sixth',
    'MINOR_SIXTH': 'Minor Sixth',
    'MAJOR_SECOND': 'Major Second',
    'MINOR_SECOND': 'Minor Second'
  };

  archetypeNames.forEach(archetype => {
    createColorInput(archetypeGrid, archetypeLabels[archetype], customPal.archetypes[archetype], (color) => {
      updateCustomColor(archetype, color);
    });
  });

  archetypeSection.appendChild(archetypeGrid);
  container.appendChild(archetypeSection);

  // ===== PALETTE SHARING SECTION =====
  const sharingDivider = document.createElement('div');
  sharingDivider.style.cssText = 'border-top: 1px solid #333; margin: 20px 0;';
  container.appendChild(sharingDivider);

  const sharingTitle = document.createElement('h5');
  sharingTitle.textContent = 'ðŸ’¾ Share & Backup Palettes';
  sharingTitle.style.cssText = 'color: #00ffff; font-size: 11px; margin: 0 0 10px 0;';
  container.appendChild(sharingTitle);

  const sharingDesc = document.createElement('div');
  sharingDesc.textContent = 'Export your custom palettes to share with others or backup. Import palettes to restore previous configurations.';
  sharingDesc.style.cssText = 'color: #666; font-size: 9px; margin-bottom: 12px;';
  container.appendChild(sharingDesc);

  const sharingButtons = document.createElement('div');
  sharingButtons.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr; gap: 8px;';

  // Export button
  const exportBtn = document.createElement('button');
  exportBtn.textContent = 'ðŸ’¾ Export Palettes';
  exportBtn.style.cssText = 'padding: 8px; background: rgba(0, 255, 255, 0.1); color: #00ffff; border: 1px solid #00ffff; border-radius: 4px; font-size: 10px; cursor: pointer; transition: all 0.2s;';

  exportBtn.addEventListener('mouseover', () => {
    exportBtn.style.background = 'rgba(0, 255, 255, 0.2)';
    exportBtn.style.transform = 'scale(1.02)';
  });

  exportBtn.addEventListener('mouseout', () => {
    exportBtn.style.background = 'rgba(0, 255, 255, 0.1)';
    exportBtn.style.transform = 'scale(1)';
  });

  exportBtn.addEventListener('click', () => {
    downloadPalettesJSON();
    exportBtn.textContent = 'âœ… Exported!';
    setTimeout(() => {
      exportBtn.textContent = 'ðŸ’¾ Export Palettes';
    }, 2000);
  });

  sharingButtons.appendChild(exportBtn);

  // Import button
  const importBtn = document.createElement('button');
  importBtn.textContent = 'ðŸ“‚ Import Palettes';
  importBtn.style.cssText = 'padding: 8px; background: rgba(102, 68, 170, 0.1); color: #6644aa; border: 1px solid #6644aa; border-radius: 4px; font-size: 10px; cursor: pointer; transition: all 0.2s;';

  importBtn.addEventListener('mouseover', () => {
    importBtn.style.background = 'rgba(102, 68, 170, 0.2)';
    importBtn.style.transform = 'scale(1.02)';
  });

  importBtn.addEventListener('mouseout', () => {
    importBtn.style.background = 'rgba(102, 68, 170, 0.1)';
    importBtn.style.transform = 'scale(1)';
  });

  // Hidden file input for import
  const paletteFileInput = document.createElement('input');
  paletteFileInput.type = 'file';
  paletteFileInput.accept = '.json';
  paletteFileInput.style.display = 'none';
  container.appendChild(paletteFileInput);

  importBtn.addEventListener('click', () => {
    paletteFileInput.click();
  });

  paletteFileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const data = JSON.parse(event.target.result);
          const success = importPalettes(data);

          if (success) {
            importBtn.textContent = 'âœ… Imported!';
            alert('âœ… Palettes imported successfully!');
            createCustomColorEditor(container); // Rebuild UI with imported colors

            setTimeout(() => {
              importBtn.textContent = 'ðŸ“‚ Import Palettes';
            }, 2000);
          } else {
            importBtn.textContent = 'âŒ Import Failed';
            alert('âŒ Failed to import palettes. Invalid format.');
            setTimeout(() => {
              importBtn.textContent = 'ðŸ“‚ Import Palettes';
            }, 2000);
          }
        } catch (error) {
          console.error('âŒ Palette import error:', error);
          importBtn.textContent = 'âŒ Import Failed';
          alert('âŒ Failed to parse palette file: ' + error.message);
          setTimeout(() => {
            importBtn.textContent = 'ðŸ“‚ Import Palettes';
          }, 2000);
        }
      };
      reader.readAsText(file);
      paletteFileInput.value = ''; // Reset input
    }
  });

  sharingButtons.appendChild(importBtn);
  container.appendChild(sharingButtons);

  // ===== VERSION CONTROL SECTION =====
  const versionDivider = document.createElement('div');
  versionDivider.style.cssText = 'border-top: 1px solid #333; margin: 20px 0;';
  container.appendChild(versionDivider);

  const versionTitle = document.createElement('h5');
  versionTitle.textContent = 'ðŸ“š Version History';
  versionTitle.style.cssText = 'color: #00ffff; font-size: 11px; margin: 0 0 10px 0;';
  container.appendChild(versionTitle);

  const versionDesc = document.createElement('div');
  versionDesc.textContent = 'Save and restore different versions of your custom palette. Track changes over time.';
  versionDesc.style.cssText = 'color: #888; font-size: 9px; margin-bottom: 12px; line-height: 1.4;';
  container.appendChild(versionDesc);

  // Save version button
  const saveVersionBtn = document.createElement('button');
  saveVersionBtn.textContent = 'ðŸ’¾ Save Current Version';
  saveVersionBtn.style.cssText = 'width: 100%; padding: 8px; background: rgba(0, 255, 0, 0.15); border: 1px solid #00ff00; border-radius: 4px; color: #00ff00; cursor: pointer; margin-bottom: 12px; font-size: 10px;';
  saveVersionBtn.addEventListener('click', () => {
    const versionName = prompt('Enter version name (or leave empty for auto-generated):');
    if (versionName !== null) {
      const description = prompt('Enter description (optional):') || '';
      savePaletteVersion(versionName || undefined, description);
      saveVersionBtn.textContent = 'âœ… Version Saved!';
      setTimeout(() => {
        saveVersionBtn.textContent = 'ðŸ’¾ Save Current Version';
        renderVersionList();
      }, 1500);
    }
  });
  container.appendChild(saveVersionBtn);

  // Version list container
  const versionListContainer = document.createElement('div');
  versionListContainer.id = 'version-list-container';
  versionListContainer.style.cssText = 'max-height: 200px; overflow-y: auto; margin-bottom: 12px;';
  container.appendChild(versionListContainer);

  // Render version list
  function renderVersionList() {
    const versions = getPaletteVersions();
    versionListContainer.innerHTML = '';

    if (versions.length === 0) {
      versionListContainer.innerHTML = '<div style="color: #666; font-size: 9px; font-style: italic;">No saved versions yet. Save your current palette to create the first version!</div>';
      return;
    }

    versions.forEach(version => {
      const versionItem = document.createElement('div');
      versionItem.style.cssText = 'background: rgba(102, 68, 170, 0.1); border: 1px solid #6644aa; border-radius: 4px; padding: 8px; margin-bottom: 6px;';

      const versionHeader = document.createElement('div');
      versionHeader.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;';

      const versionNameEl = document.createElement('div');
      versionNameEl.textContent = version.name;
      versionNameEl.style.cssText = 'color: #00ffff; font-size: 10px; font-weight: 500;';
      versionHeader.appendChild(versionNameEl);

      const versionActions = document.createElement('div');
      versionActions.style.cssText = 'display: flex; gap: 4px;';

      // Restore button
      const restoreBtn = document.createElement('button');
      restoreBtn.textContent = 'â™»ï¸';
      restoreBtn.title = 'Restore this version';
      restoreBtn.style.cssText = 'background: rgba(0, 255, 0, 0.2); border: 1px solid #00ff00; border-radius: 3px; color: #00ff00; cursor: pointer; padding: 2px 6px; font-size: 9px;';
      restoreBtn.addEventListener('click', () => {
        if (confirm(`Restore version "${version.name}"?\n\nThis will replace your current palette.`)) {
          if (restorePaletteVersion(version.id)) {
            alert(`âœ… Restored version: ${version.name}`);
            createCustomColorEditor(container); // Rebuild UI
          } else {
            alert('âŒ Failed to restore version');
          }
        }
      });
      versionActions.appendChild(restoreBtn);

      // Delete button
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'ðŸ—‘ï¸';
      deleteBtn.title = 'Delete this version';
      deleteBtn.style.cssText = 'background: rgba(255, 0, 0, 0.2); border: 1px solid #ff0000; border-radius: 3px; color: #ff0000; cursor: pointer; padding: 2px 6px; font-size: 9px;';
      deleteBtn.addEventListener('click', () => {
        if (confirm(`Delete version "${version.name}"?\n\nThis cannot be undone.`)) {
          if (deletePaletteVersion(version.id)) {
            renderVersionList();
          }
        }
      });
      versionActions.appendChild(deleteBtn);

      versionHeader.appendChild(versionActions);
      versionItem.appendChild(versionHeader);

      const versionInfo = document.createElement('div');
      versionInfo.style.cssText = 'color: #888; font-size: 8px;';
      versionInfo.innerHTML = `${version.date}${version.description ? `<br><span style="color: #aaa;">${version.description}</span>` : ''}`;
      versionItem.appendChild(versionInfo);

      versionListContainer.appendChild(versionItem);
    });
  }

  // Initial render
  renderVersionList();

  // Export/Import version history buttons
  const versionHistoryButtons = document.createElement('div');
  versionHistoryButtons.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr; gap: 8px;';

  const exportHistoryBtn = document.createElement('button');
  exportHistoryBtn.textContent = 'ðŸ’¾ Export History';
  exportHistoryBtn.style.cssText = 'padding: 6px; background: rgba(0, 255, 255, 0.1); border: 1px solid #00ffff; border-radius: 4px; color: #00ffff; cursor: pointer; font-size: 9px;';
  exportHistoryBtn.addEventListener('click', () => {
    const data = exportVersionHistory();
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `mmpa-version-history-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    exportHistoryBtn.textContent = 'âœ… Exported!';
    setTimeout(() => {
      exportHistoryBtn.textContent = 'ðŸ’¾ Export History';
    }, 1500);
  });
  versionHistoryButtons.appendChild(exportHistoryBtn);

  const importHistoryBtn = document.createElement('button');
  importHistoryBtn.textContent = 'ðŸ“‚ Import History';
  importHistoryBtn.style.cssText = 'padding: 6px; background: rgba(255, 0, 255, 0.1); border: 1px solid #ff00ff; border-radius: 4px; color: #ff00ff; cursor: pointer; font-size: 9px;';

  const historyFileInput = document.createElement('input');
  historyFileInput.type = 'file';
  historyFileInput.accept = '.json';
  historyFileInput.style.display = 'none';

  importHistoryBtn.addEventListener('click', () => {
    historyFileInput.click();
  });

  historyFileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const data = JSON.parse(event.target.result);
          const merge = confirm('Merge with existing versions?\n\nYes = Merge (keep both)\nNo = Replace (delete existing)');
          if (importVersionHistory(data, merge)) {
            importHistoryBtn.textContent = 'âœ… Imported!';
            alert('âœ… Version history imported successfully!');
            renderVersionList();
            setTimeout(() => {
              importHistoryBtn.textContent = 'ðŸ“‚ Import History';
            }, 1500);
          } else {
            importHistoryBtn.textContent = 'âŒ Import Failed';
            alert('âŒ Failed to import version history. Invalid format.');
            setTimeout(() => {
              importHistoryBtn.textContent = 'ðŸ“‚ Import History';
            }, 1500);
          }
        } catch (error) {
          console.error('âŒ History import error:', error);
          importHistoryBtn.textContent = 'âŒ Import Failed';
          alert('âŒ Failed to parse version history file: ' + error.message);
          setTimeout(() => {
            importHistoryBtn.textContent = 'ðŸ“‚ Import History';
          }, 1500);
        }
      };
      reader.readAsText(file);
      historyFileInput.value = '';
    }
  });

  versionHistoryButtons.appendChild(importHistoryBtn);
  container.appendChild(versionHistoryButtons);
}

// Helper to create a color input row
function createColorInput(container, label, initialColor, onChange) {
  const row = document.createElement('div');
  row.style.cssText = 'display: flex; align-items: center; gap: 8px;';

  const labelEl = document.createElement('label');
  labelEl.textContent = label;
  labelEl.style.cssText = 'flex: 1; color: #00ffff; font-size: 10px;';
  row.appendChild(labelEl);

  const colorInput = document.createElement('input');
  colorInput.type = 'color';
  colorInput.value = initialColor;
  colorInput.style.cssText = 'width: 40px; height: 24px; background: #1a1a1a; border: 1px solid #6644aa; border-radius: 3px; cursor: pointer;';

  colorInput.addEventListener('change', (e) => {
    onChange(e.target.value);
  });

  row.appendChild(colorInput);

  const hexDisplay = document.createElement('span');
  hexDisplay.textContent = initialColor;
  hexDisplay.style.cssText = 'font-family: monospace; font-size: 9px; color: #666; width: 60px;';

  colorInput.addEventListener('input', (e) => {
    hexDisplay.textContent = e.target.value;
  });

  row.appendChild(hexDisplay);
  container.appendChild(row);
}
